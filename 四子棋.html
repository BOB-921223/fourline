<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å››å­æ£‹éŠæˆ²</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #F5EFE4;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
}
#board {
  display: grid;
  grid-template-columns: repeat(7, 70px);
  grid-template-rows: repeat(6, 70px);
  gap: 5px;
  background: #004080;
  padding: 5px;
  border-radius: 10px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  margin-top: 20px;
}
.cell {
  width: 70px;
  height: 70px;
  background: #87b4ff;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}
.cell.empty:hover {
  background: #bcd4ff;
  cursor: pointer;
}
.disc {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  box-shadow: inset 0 3px 10px rgba(0,0,0,0.3);
}
.disc.p1 { background: red; }
.disc.p2 { background: yellow; }

.disc.falling {
  transition: top 0.4s cubic-bezier(0.25, 0.7, 0.3, 1.2);
  box-shadow: 0 8px 14px rgba(0,0,0,0.4);
}

#status {
  margin-top: 20px;
  font-size: 20px;
  font-weight: bold;
}

#overlay, #victoryPopup, #roomOptionsPopup, #createRoomPopup, #joinRoomPopup {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.6);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}

.popup {
  background: white;
  border-radius: 12px;
  padding: 30px;
  text-align: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.popup h2 {
  margin-bottom: 15px;
}

button {
  background: #004080;
  color: white;
  border: none;
  padding: 10px 20px;
  margin-top: 12px;
  border-radius: 8px;
  cursor: pointer;
}
button:hover {
  background: #0059b3;
}

.mode-btn {
  display: block;
  width: 100%;
  margin: 8px 0;
  background: #2a7be4;
}

#credits {
  position: fixed; /* å›ºå®šåœ¨è¦–çª—ä¸Š */
  bottom: 10px;    /* é›¢åº•éƒ¨ 10px */
  right: 15px;     /* é›¢å³å´ 15px */
  font-size: 14px;
  color: #555;      /* æ·±ç°è‰² */
  z-index: 900;      /* ç¢ºä¿å®ƒåœ¨å½ˆå‡ºè¦–çª—(1000)çš„ä¸‹é¢ */
}

#musicControl {
  position: fixed;
  bottom: 10px;
  left: 15px;
  font-size: 14px;
  color: #555;
  cursor: pointer;
  z-index: 900;
}
#musicControl:hover {
  color: #000; /* æ»‘é¼ æ‡¸åœæ™‚è®Šè‰² */
}

#victoryPopup { display: none; }
</style>
</head>
<body>

<h1>å››å­æ£‹éŠæˆ²</h1>
<div id="status"></div>
<div id="board"></div>

<div id="overlay">
  <div class="popup">
    <h2>è«‹è¼¸å…¥æš±ç¨±</h2>
    <input type="text" id="playerName" placeholder="ç©å®¶ä¸€" style="padding:8px; border-radius:5px; border:1px solid #aaa;">
    <h3>é¸æ“‡éŠæˆ²æ¨¡å¼</h3>
   <button class="mode-btn" onclick="selectGameMode('ai')">AI å°æˆ°(å¾ˆå¼·çš„å–”)</button>
    <button class="mode-btn" onclick="selectGameMode('local')">æœ¬æ©Ÿå°æˆ°</button>
    <button class="mode-btn" onclick="selectGameMode('online')">é€£ç·šå°æˆ°</button>
  </div>
</div>

<div id="victoryPopup">
  <div class="popup">
    <h2 id="winnerText"></h2>
    <button onclick="resetGame()">é‡æ–°é–‹å§‹</button>
  </div>
</div>

<div id="roomOptionsPopup" style="display: none;">
  <div class="popup">
    <h2>é€£ç·šå°æˆ°</h2>
    <button class="mode-btn" onclick="showCreateRoomPopup()">å‰µå»ºæˆ¿é–“</button>
    <button class="mode-btn" onclick="showJoinRoomPopup()">æœå°‹æˆ¿é–“</button>
    <button onclick="closeRoomOptions()" style="background: #777;">è¿”å›</button>
  </div>
</div>

<div id="createRoomPopup" style="display: none;">
  <div class="popup">
    <h2>æˆ¿é–“ä»£ç¢¼</h2>
    <h3 id="roomCodeDisplay" style="font-size: 2.5em; letter-spacing: 4px; margin: 10px 0;">----</h3>
    <p id="createStatus">æ­£åœ¨é€£æ¥ä¼ºæœå™¨...</p>
    <button onclick="cancelRoomCreation()" style="background: #777;">å–æ¶ˆ</button>
  </div>
</div>

<div id="joinRoomPopup" style="display: none;">
  <div class="popup">
    <h2>æœå°‹æˆ¿é–“</h2>
    <input type="text" id="roomCodeInput" placeholder="è¼¸å…¥ 4 ä½ä»£ç¢¼" maxlength="4" style="padding: 10px; font-size: 1.2em; text-align: center; letter-spacing: 2px; width: 150px;">
    <button class="mode-btn" onclick="submitJoinRoom()">åŠ å…¥</button>
    <button onclick="closeJoinRoomPopup()" style="background: #777;">å–æ¶ˆ</button>
  </div>
</div>

<div id="credits">è£½ä½œäººBOB</div>

<audio id="backgroundMusic" src="music.mp3" loop></audio>
<div id="musicControl" onclick="toggleMusic()">ğŸ”‡ æ’­æ”¾</div>
<script src="/socket.io/socket.io.js"></script>

<script>
const ROWS = 6, COLS = 7;
let boardState, turn, winner = 0;
let isProcessingMove = false; 
let mode = 'local';
let player1Name = 'ç©å®¶ä¸€', player2Name = 'ç©å®¶äºŒ';

// â–¼â–¼â–¼ æ–°å¢é€£ç·šå°æˆ°ç”¨çš„è®Šæ•¸ â–¼â–¼â–¼
let socket;
let myPlayerNumber; 
// â–²â–²â–²

const bgMusic = document.getElementById('backgroundMusic');
bgMusic.volume = 0.4; //bgmè²éŸ³èª¿æ•´
let hasMusicStarted = false;
const boardEl = document.getElementById('board');
document.addEventListener('click', () => {
  // æª¢æŸ¥éŸ³æ¨‚æ˜¯å¦å·²ç¶“é–‹å§‹
  if (!hasMusicStarted) {
    // å˜—è©¦æ’­æ”¾éŸ³æ¨‚
    const playPromise = bgMusic.play();
    if (playPromise !== undefined) {
      playPromise.then(_ => {
        // æ’­æ”¾æˆåŠŸ
        document.getElementById('musicControl').textContent = 'ğŸµ éœéŸ³';
        hasMusicStarted = true;
      }).catch(error => {
        // æ’­æ”¾å¤±æ•— (ä¾‹å¦‚ç€è¦½å™¨ä»é˜»æ­¢)
        console.warn("éŸ³æ¨‚æ’­æ”¾å¤±æ•—", error);
        document.getElementById('musicControl').textContent = 'ğŸ”‡ æ’­æ”¾';
        hasMusicStarted = false;
      });
    }
  }
}, { once: true });
const statusEl = document.getElementById('status');

for (let r = 0; r < ROWS * COLS; r++) {
  const cell = document.createElement('div');
  cell.className = 'cell empty';
  cell.addEventListener('click', () => handleMove(Math.floor(r / COLS), r % COLS));
  boardEl.appendChild(cell);
}

// (åˆªé™¤èˆŠçš„ startGame å’Œ initSocket)
// â–¼â–¼â–¼ è²¼ä¸Šä»¥ä¸‹æ‰€æœ‰æ–°å‡½æ•¸ â–¼â–¼â–¼

function selectGameMode(selectedMode) {
  mode = selectedMode;
  // (1) å…ˆå–å¾—æš±ç¨±
  player1Name = document.getElementById('playerName').value.trim() || 'ç©å®¶ä¸€';
  
  // éš±è—æš±ç¨±è¦–çª—
  document.getElementById('overlay').style.display = 'none';

  if (mode === 'online') {
    // (2) é¡¯ç¤º"é€£ç·šå°æˆ°"é¸é …
    document.getElementById('roomOptionsPopup').style.display = 'flex';
    setStatus(''); // æ¸…é™¤ç‹€æ…‹
  } else {
    // (3) AI æˆ– æœ¬æ©Ÿæ¨¡å¼ (ç¶­æŒèˆŠé‚è¼¯)
    player2Name = (mode === 'ai') ? 'AI' : 'ç©å®¶äºŒ';
    const startingPlayer = Math.floor(Math.random() * 2) + 1; 
    initGame(startingPlayer); 
  }
}

// --- æˆ¿é–“ä»‹é¢æ§åˆ¶ (æ–°å‡½æ•¸) ---

function showCreateRoomPopup() {
  document.getElementById('roomOptionsPopup').style.display = 'none';
  document.getElementById('createRoomPopup').style.display = 'flex';
  document.getElementById('createStatus').textContent = 'æ­£åœ¨é€£æ¥ä¼ºæœå™¨...';
  document.getElementById('roomCodeDisplay').textContent = '----';
  initSocketAndCreateRoom(); // (é—œéµ)
}

function showJoinRoomPopup() {
  document.getElementById('roomOptionsPopup').style.display = 'none';
  document.getElementById('joinRoomPopup').style.display = 'flex';
  setStatus(''); // æ¸…é™¤ç‹€æ…‹
}

function closeRoomOptions() {
  document.getElementById('roomOptionsPopup').style.display = 'none';
  document.getElementById('overlay').style.display = 'flex'; // è¿”å›æš±ç¨±è¦–çª—
}

function cancelRoomCreation() {
  if (socket) socket.disconnect();
  document.getElementById('createRoomPopup').style.display = 'none';
  document.getElementById('roomOptionsPopup').style.display = 'flex';
}

function closeJoinRoomPopup() {
  document.getElementById('joinRoomPopup').style.display = 'none';
  document.getElementById('roomOptionsPopup').style.display = 'flex';
}

// --- Socket æ ¸å¿ƒé‚è¼¯ (é‡æ§‹) ---

// (A) ç›£è½å™¨
function initSocketListeners() {
  // 1. (ä¼ºæœå™¨å›æ‡‰) æˆ¿é–“å·²å‰µå»º
  socket.on('roomCreated', (data) => {
    document.getElementById('roomCodeDisplay').textContent = data.roomCode;
    document.getElementById('createStatus').textContent = 'ç­‰å¾…å°æ‰‹åŠ å…¥...';
  });

  // 2. (ä¼ºæœå™¨å›æ‡‰) åŠ å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤
  socket.on('joinError', (data) => {
    setStatus(data.message);
    if(socket) socket.disconnect();
    // ä»‹é¢é‡ç½®
    document.getElementById('joinRoomPopup').style.display = 'none';
    document.getElementById('roomOptionsPopup').style.display = 'flex';
  });

  // 3. (ä¼ºæœå™¨å»£æ’­) éŠæˆ²é–‹å§‹
  socket.on('gameStart', (data) => {
    // éš±è—æ‰€æœ‰å½ˆå‡ºè¦–çª—
    document.getElementById('createRoomPopup').style.display = 'none';
    document.getElementById('joinRoomPopup').style.display = 'none';

    // (ä»¥ä¸‹é‚è¼¯èˆ‡æ‚¨ä¸Šä¸€å€‹ç‰ˆæœ¬ç›¸åŒ)
    myPlayerNumber = data.playerNumber;
    if (myPlayerNumber === 1) {
        player1Name = data.yourName;
        player2Name = data.opponentName;
    } else {
        player1Name = data.opponentName;
        player2Name = data.yourName;
    }
    initGame(1); // P1 (ç´…æ£‹) æ°¸é å…ˆæ‰‹
    if (myPlayerNumber === 1) {
      setStatus(`éŠæˆ²é–‹å§‹ï¼æ‚¨å…ˆæ‰‹ (${player1Name})`);
      isProcessingMove = false;
    } else {
      setStatus(`éŠæˆ²é–‹å§‹ï¼å°æ‰‹å…ˆæ‰‹ (${player1Name})`);
      isProcessingMove = true;
    }
  });

  // 4. (ä¼ºæœå™¨å»£æ’­) å°æ‰‹ç§»å‹•
  socket.on('opponentMove', (data) => {
    if (winner) return;
    isProcessingMove = true; 
    placeDisc(data.r, data.c, data.player);
  });

  // 5. (ä¼ºæœå™¨å»£æ’­) å°æ‰‹æ–·ç·š
  socket.on('opponentLeft', () => {
    if (!winner) {
      winner = myPlayerNumber; 
      setStatus('å°æ‰‹å·²é›¢é–‹é€£ç·šï¼Œæ‚¨ç²å‹äº†ï¼');
      isProcessingMove = true; 
    }
  });
}

// (B) å‰µå»ºæˆ¿é–“çš„å‹•ä½œ
function initSocketAndCreateRoom() {
  if (socket) socket.disconnect();
  socket = io();
  initSocketListeners(); // ç¶å®šæ‰€æœ‰ .on() äº‹ä»¶
  
  // é€£ç·šæˆåŠŸå¾Œï¼Œè‡ªå‹•ç™¼é€ 'createRoom'
  socket.on('connect', () => {
    document.getElementById('createStatus').textContent = 'æ­£åœ¨å‰µå»ºæˆ¿é–“...';
    socket.emit('createRoom', { name: player1Name });
  });
}

// (C) åŠ å…¥æˆ¿é–“çš„å‹•ä½œ
function submitJoinRoom() {
  const roomCode = document.getElementById('roomCodeInput').value.trim();
  if (roomCode.length !== 4) {
    setStatus('è«‹è¼¸å…¥ 4 ä½æˆ¿é–“ä»£ç¢¼');
    return;
  }
  
  setStatus('æ­£åœ¨åŠ å…¥æˆ¿é–“...');
  if (socket) socket.disconnect();
  socket = io();
  initSocketListeners(); // ç¶å®šæ‰€æœ‰ .on() äº‹ä»¶

  // é€£ç·šæˆåŠŸå¾Œï¼Œè‡ªå‹•ç™¼é€ 'joinRoom'
  socket.on('connect', () => {
    socket.emit('joinRoom', { name: player1Name, roomCode: roomCode });
  });
}

// â–²â–²â–² æ–°å‡½æ•¸åˆ°æ­¤çµæŸ â–²â–²â–²

// (initGame å‡½æ•¸ç¶­æŒä¸è®Š)
function initGame(startingPlayer) { // <-- æ¥æ”¶åƒæ•¸
  boardState = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
  
  turn = startingPlayer || 1; // ä½¿ç”¨å‚³å…¥çš„åƒæ•¸ï¼Œè‹¥ç„¡å‰‡é è¨­ 1
  winner = 0;
  render();
  
  // æ›´æ–°ç‹€æ…‹æ–‡å­—ï¼Œä½¿å…¶èƒ½æ­£ç¢ºé¡¯ç¤º P1 æˆ– P2
  setStatus(`${turn === 1 ? player1Name : player2Name} çš„å›åˆ`);
  isProcessingMove = false; // é è¨­è§£é–

  // å¦‚æœæ˜¯ AI æ¨¡å¼ ä¸” AI (ç©å®¶2) å…ˆæ‰‹ï¼Œå‰‡è‡ªå‹•ä¸‹æ£‹
  if (mode === 'ai' && turn === 2) {
    isProcessingMove = true; // AI å…ˆæ‰‹ï¼Œå…ˆé–å®š
    setTimeout(aiMove, 700); 
  }
}

function render() {
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const idx = r * COLS + c;
      const cell = boardEl.children[idx];
      cell.innerHTML = '';
      cell.classList.toggle('empty', boardState[r][c] === 0);
      if (boardState[r][c] !== 0) {
        const disc = document.createElement('div');
        disc.className = 'disc ' + (boardState[r][c] === 1 ? 'p1' : 'p2');
        cell.appendChild(disc);
      }
    }
  }
}

// â–¼â–¼â–¼ å·²ä¿®æ”¹ï¼šåŠ å…¥ 'online' æ¨¡å¼çš„æª¢æŸ¥å’Œç™¼é€ â–¼â–¼â–¼
function handleMove(r, c) {
  if (winner || isProcessingMove) return; 
  if (mode === 'ai' && turn === 2) return; 
  
  // â–¼â–¼â–¼ æ–°å¢ï¼šç·šä¸Šæ¨¡å¼æ™‚ï¼Œåªèƒ½åœ¨è¼ªåˆ°è‡ªå·±æ™‚ä¸‹æ£‹ â–¼â–¼â–¼
  if (mode === 'online' && turn !== myPlayerNumber) return;
  // â–²â–²â–²

  const col = c;
  let row = -1;
  for (let rr = ROWS - 1; rr >= 0; rr--) {
    if (boardState[rr][col] === 0) { row = rr; break; }
  }
  if (row === -1) return; // æ¬„ä½å·²æ»¿ï¼Œä¹Ÿè¿”å›

  isProcessingMove = true; // æ‰¾åˆ°äº†æœ‰æ•ˆç§»å‹•ï¼Œç«‹åˆ»ä¸Šé–
  placeDisc(row, col, turn);

  // â–¼â–¼â–¼ æ–°å¢ï¼šå¦‚æœæ˜¯ç·šä¸Šæ¨¡å¼ï¼Œå°‡ç§»å‹•ç™¼é€çµ¦ä¼ºæœå™¨ â–¼â–¼â–¼
  if (mode === 'online') {
    socket.emit('makeMove', { r: row, c: col, player: turn });
  }
  // â–²â–²â–²
}

function placeDisc(r, c, player) {
  const idx = r * COLS + c;
  const cellEl = boardEl.children[idx];
  const disc = document.createElement('div');
  disc.className = 'disc ' + (player === 1 ? 'p1' : 'p2') + ' falling';
  document.body.appendChild(disc);

  const boardRect = boardEl.getBoundingClientRect();
  const cellRect = cellEl.getBoundingClientRect();
  const startX = cellRect.left + cellRect.width / 2;
  const startY = boardRect.top - 80;
  const endY = cellRect.top + cellRect.height / 2;

  disc.style.position = 'fixed';
  disc.style.left = `${startX - 35}px`;
  disc.style.top = `${startY}px`;
  disc.style.zIndex = 9999;
  disc.style.transition = 'top 0.4s ease-in';

  requestAnimationFrame(() => {
    disc.style.top = `${endY - 35}px`;
  });

  // â–¼â–¼â–¼ å·²ä¿®æ”¹ï¼šé‡å¯« 'transitionend' çš„è§£é–é‚è¼¯ â–¼â–¼â–¼
  disc.addEventListener('transitionend', () => {
    disc.remove();
    boardState[r][c] = player; // 'player' æ˜¯ *å‰›å‰›* ä¸‹æ£‹çš„äºº
    render();

    if (checkWin(r, c, player)) {
      winner = player;
      showVictory(player === 1 ? player1Name : player2Name);
      isProcessingMove = false; // éŠæˆ²çµæŸï¼Œæ°¸é è§£é–
      return; // åœæ­¢å¾ŒçºŒè™•ç†
    }

    // éŠæˆ²æœªçµæŸï¼Œåˆ‡æ›å›åˆ
    turn = 3 - player;
    setStatus(`${turn === 1 ? player1Name : player2Name} çš„å›åˆ`);

    // --- æ ¹æ“šä¸åŒæ¨¡å¼æ±ºå®šæ˜¯å¦è§£é– ---

    if (mode === 'ai') {
      if (turn === AI_PLAYER) {
        // è¼ªåˆ° AIï¼Œä¿æŒé–å®šä¸¦å‘¼å« AI
        setTimeout(aiMove, 700);
      } else {
        // è¼ªåˆ°äººé¡ï¼Œè§£é–
        isProcessingMove = false;
      }
    } else if (mode === 'local') {
      // è¼ªåˆ°å¦ä¸€å€‹äººé¡ï¼Œè§£é–
      isProcessingMove = false;
    } else if (mode === 'online') {
      if (turn === myPlayerNumber) {
        // å°æ‰‹å‰›ä¸‹å®Œï¼Œè¼ªåˆ°æˆ‘äº†ï¼Œè§£é–
        isProcessingMove = false;
      } else {
        // æˆ‘å‰›ä¸‹å®Œï¼Œè¼ªåˆ°å°æ‰‹ï¼Œä¿æŒé–å®š
      }
    }
  });
}

// é€™æ˜¯æ‚¨æª”æ¡ˆä¸­åŸæœ‰çš„ (ä¿ç•™)
function getAvailableRow(col) {
  for (let r = ROWS - 1; r >= 0; r--) {
    if (boardState[r][col] === 0) return r;
  }
  return -1;
}


// --- AI å¼·åŒ–å€å¡Šé–‹å§‹ (Minimax) ---
// (æ­¤å€å¡Šå®Œå…¨ä¸è®Šï¼Œä¿ç•™æ‚¨åŸæœ¬çš„ AI é‚è¼¯)

const AI_PLAYER = 2;
const HUMAN_PLAYER = 1;
const EMPTY = 0;
const SEARCH_DEPTH = 5; 
const SCORE_WIN = 1000000;
const SCORE_THREE = 5000; 
const SCORE_TWO = 50;
const SCORE_CENTER_BONUS = 10; 

function evaluateWindow(window, player) {
  let score = 0;
  const oppPlayer = (player === AI_PLAYER) ? HUMAN_PLAYER : AI_PLAYER;
  const playerCount = window.filter(p => p === player).length;
  const oppCount = window.filter(p => p === oppPlayer).length;
  const emptyCount = window.filter(p => p === EMPTY).length;

  if (playerCount === 4) {
    score += SCORE_WIN;
  } else if (playerCount === 3 && emptyCount === 1) {
    score += SCORE_THREE;
  } else if (playerCount === 2 && emptyCount === 2) {
    score += SCORE_TWO;
  }
  if (oppCount === 3 && emptyCount === 1) {
    score -= SCORE_THREE * 0.9;
  }
  return score;
}

function scorePosition(board, player) {
  let score = 0;
  const centerCol = Math.floor(COLS / 2);
  let centerCount = 0;
  for (let r = 0; r < ROWS; r++) {
    if (board[r][centerCol] === player) {
      centerCount++;
    }
  }
  score += centerCount * SCORE_CENTER_BONUS;
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS - 3; c++) {
      const window = [board[r][c], board[r][c+1], board[r][c+2], board[r][c+3]];
      score += evaluateWindow(window, player);
    }
  }
  for (let c = 0; c < COLS; c++) {
    for (let r = 0; r < ROWS - 3; r++) {
      const window = [board[r][c], board[r+1][c], board[r+2][c], board[r+3][c]];
      score += evaluateWindow(window, player);
    }
  }
  for (let r = 0; r < ROWS - 3; r++) {
    for (let c = 0; c < COLS - 3; c++) {
      const window = [board[r][c], board[r+1][c+1], board[r+2][c+2], board[r+3][c+3]];
      score += evaluateWindow(window, player);
    }
  }
  for (let r = 3; r < ROWS; r++) { 
    for (let c = 0; c < COLS - 3; c++) {
      const window = [board[r][c], board[r-1][c+1], board[r-2][c+2], board[r-3][c+3]];
      score += evaluateWindow(window, player);
    }
  }
  return score;
}

function checkWinForPlayer(board, player) {
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS - 3; c++) {
      if (board[r][c] === player && board[r][c+1] === player && board[r][c+2] === player && board[r][c+3] === player) return true;
    }
  }
  for (let c = 0; c < COLS; c++) {
    for (let r = 0; r < ROWS - 3; r++) {
      if (board[r][c] === player && board[r+1][c] === player && board[r+2][c] === player && board[r+3][c] === player) return true;
    }
  }
  for (let r = 0; r < ROWS - 3; r++) {
    for (let c = 0; c < COLS - 3; c++) {
      if (board[r][c] === player && board[r+1][c+1] === player && board[r+2][c+2] === player && board[r+3][c+3] === player) return true;
    }
  }
  for (let r = 3; r < ROWS; r++) {
    for (let c = 0; c < COLS - 3; c++) {
      if (board[r][c] === player && board[r-1][c+1] === player && board[r-2][c+2] === player && board[r-3][c+3] === player) return true;
    }
  }
  return false;
}

function getValidMoves(board) {
  const validCols = [];
  for (let c = 0; c < COLS; c++) {
    if (board[0][c] === EMPTY) { 
      validCols.push(c);
    }
  }
  return validCols;
}

function isTerminalNode(board) {
  return checkWinForPlayer(board, HUMAN_PLAYER) || 
         checkWinForPlayer(board, AI_PLAYER) || 
         getValidMoves(board).length === 0;
}

function minimax(board, depth, alpha, beta, maximizingPlayer) {
  const validMoves = getValidMoves(board);
  const terminal = isTerminalNode(board);
  if (depth === 0 || terminal) {
    if (terminal) {
      if (checkWinForPlayer(board, AI_PLAYER)) return SCORE_WIN;
      else if (checkWinForPlayer(board, HUMAN_PLAYER)) return -SCORE_WIN;
      else return 0; 
    } else { 
      return scorePosition(board, AI_PLAYER);
    }
  }
  if (maximizingPlayer) { 
    let value = -Infinity;
    const centerPriority = [3, 2, 4, 1, 5, 0, 6];
    const orderedMoves = centerPriority.filter(c => validMoves.includes(c));
    for (const col of orderedMoves) {
      const row = getAvailableRow(col); 
      board[row][col] = AI_PLAYER; 
      value = Math.max(value, minimax(board, depth - 1, alpha, beta, false));
      board[row][col] = EMPTY; 
      alpha = Math.max(alpha, value);
      if (alpha >= beta) break; 
    }
    return value;
  } else { 
    let value = Infinity;
    const centerPriority = [3, 2, 4, 1, 5, 0, 6];
    const orderedMoves = centerPriority.filter(c => validMoves.includes(c));
    for (const col of orderedMoves) {
      const row = getAvailableRow(col);
      board[row][col] = HUMAN_PLAYER; 
      value = Math.min(value, minimax(board, depth - 1, alpha, beta, true));
      board[row][col] = EMPTY; 
      beta = Math.min(beta, value);
      if (alpha >= beta) break; 
    }
    return value;
  }
}

function aiMove() {
  if (winner) return;
  let bestScore = -Infinity;
  let bestCol = -1;
  const centerPriority = [3, 2, 4, 1, 5, 0, 6];
  const validMoves = getValidMoves(boardState);
  const orderedMoves = centerPriority.filter(c => validMoves.includes(c));
  for (const col of orderedMoves) {
    const row = getAvailableRow(col);
    if (row === -1) continue;
    boardState[row][col] = AI_PLAYER; 
    let score = minimax(boardState, SEARCH_DEPTH, -Infinity, Infinity, false);
    boardState[row][col] = EMPTY; 
    if (score > bestScore) {
      bestScore = score;
      bestCol = col;
    }
  }
  if (bestCol === -1) {
    bestCol = validMoves[0] || 3; 
  }
  const finalRow = getAvailableRow(bestCol);
  if (finalRow !== -1) {
    placeDisc(finalRow, bestCol, AI_PLAYER);
  }
}

// --- AI å¼·åŒ–å€å¡ŠçµæŸ ---


// é€™æ˜¯æ‚¨æª”æ¡ˆä¸­åŸæœ‰çš„ (ä¿ç•™)
function checkWin(r, c, p) {
  const dirs = [[1,0],[0,1],[1,1],[1,-1]];
  for (const [dr,dc] of dirs) {
    let count = 1;
    for (let i=1;i<4;i++){ const nr=r+dr*i, nc=c+dc*i; if(nr<0||nr>=ROWS||nc<0||nc>=COLS||boardState[nr][nc]!==p) break; count++; }
    for (let i=1;i<4;i++){ const nr=r-dr*i, nc=c-dc*i; if(nr<0||nr>=ROWS||nc<0||nc>=COLS||boardState[nr][nc]!==p) break; count++; }
    if (count>=4) return true;
  }
  return false;
}

// D é€™æ˜¯æ‚¨æª”æ¡ˆä¸­åŸæœ‰çš„ (ä¿ç•™)
function setStatus(text){ statusEl.textContent = text; }

// é€™æ˜¯æ‚¨æª”æ¡ˆä¸­åŸæœ‰çš„ (ä¿ç•™)
function showVictory(name){
  document.getElementById('winnerText').textContent = `${name} å‹åˆ©ï¼`;
  document.getElementById('victoryPopup').style.display = 'flex';
}

// â–¼â–¼â–¼ å·²ä¿®æ”¹ï¼šåŠ å…¥ socket.disconnect() â–¼â–¼â–¼
function resetGame(){
  // å¦‚æœæœ‰é€£ç·šï¼Œå‰‡æ–·é–‹
  if (socket) {
    socket.disconnect();
    socket = null;
    myPlayerNumber = null;
  }
  
  // éš±è—æ‰€æœ‰éŠæˆ²è¦–çª—/å½ˆå‡ºè¦–çª—
  document.getElementById('victoryPopup').style.display = 'none';
  document.getElementById('roomOptionsPopup').style.display = 'none';
  document.getElementById('createRoomPopup').style.display = 'none';
  document.getElementById('joinRoomPopup').style.display = 'none';
  
  // é¡¯ç¤ºä¸€é–‹å§‹çš„æš±ç¨±è¦–çª—
  document.getElementById('overlay').style.display = 'flex';
}

function toggleMusic() {
  const musicControl = document.getElementById('musicControl');
  if (bgMusic.paused) {
    bgMusic.play();
    musicControl.textContent = 'ğŸµ éœéŸ³';
    hasMusicStarted = true; // ç¢ºä¿æ——æ¨™è¢«è¨­å®š
  } else {
    bgMusic.pause();
    musicControl.textContent = 'ğŸ”‡ æ’­æ”¾';
  }
}
</script>
</body>
</html>